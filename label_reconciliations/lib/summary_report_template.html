<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8" />
<title>{{header.title}}</title>
<style>
  :root {
    --bg-gray: #ddd;
    --bg-problem: #f8cbcb;
    --bg-unreconciled: #a6f3a6;
  }

  html {
    font-family: "Bitstream Vera Serif Bold";
  }

  header h1 {
    text-align: center;
  }

  header div {
    font-size: 16px;
    width: 360px;
    margin-bottom: 4px;
  }

  header div label {
    text-align: right;
    display: inline-block;
    width: 200px;
  }

  header div span {
    float: right;
  }

  section {
    margin-top: 2em;
    margin-bottom: 1em;
  }

  tbody td {
    border-bottom: 1px solid var(--bg-gray);
  }

  th {
    padding: 2px 4px;
    vertical-align: bottom;
  }

  #stats thead tr:nth-child(1) th:nth-child(2) {
    background: lightgray;
  }

  #stats thead tr:nth-child(2) th,
  #users thead tr {
    text-decoration: underline;
  }

  th.right,
  td.right {
    text-align: right;
  }

  th.left {
    text-align: left;
  }

  td.left {
    padding-left: 4px;
  }

  td.right{
    padding-right: 12px;
  }

  #details table {
    margin-top: 24px;
  }

  #details th {
    text-align: left;
    text-decoration: underline;
  }

  #details th.no-ul {
    text-decoration: none;
  }

  #details tr button:before {
    content: '-';
  }

  #details tr.closed button:before {
    content: '+';
  }

  #details tr.closed[data-row-type="{{row_types.explanations}}"],
  #details tr.closed[data-row-type="{{row_types.unreconciled}}"] {
    display: none;
  }

  #details tr[data-row-type="{{row_types.explanations}}"] td.filled {
    background-color: var(--bg-gray);
  }

  #details tr[data-row-type="{{row_types.unreconciled}}"] td {
    background-color: var(--bg-unreconciled);
  }

  #details tr[data-row-type="{{row_types.unreconciled}}"] td:first-child,
  #details tr[data-row-type="{{row_types.unreconciled}}"] td:nth-child(2) {
    background-color: white;
  }

  #details td.problem {
    background-color: var(--bg-problem);
  }

  #details tbody tr.hide {
    display: none;
  }

  #details label {
    font-size: larger;
  }

  #details select,
  #details option {
    font-size: medium;
    padding: 2px;
  }

  #users .users-container {
    display: inline-block;
    overflow-y: scroll;
    height: 280px;
    min-height: 280px;
    padding-right: 8px;
    margin-bottom: 12px;
    transition: height 300ms ease;
  }

  #users .users-container.expanded {
    height: 100%;
    min-height: 100%;
    transition: height 300ms ease;
  }

  #users button {
    display: block;
    margin: 12px 0;
  }

  #users button:before {
    content: 'Show All';
  }

  #users button.expanded:before {
    content: 'Show Fewer';
  }

  .bar rect {
    fill: steelblue;
  }

  .bar text {
    fill: #fff;
    font: 10px sans-serif;
  }

</style>
</head>

<body>

  <header>
    <h1>{{header.heading}}</h1>
    <div><label>Date:</label><span>{{header.date}}</span></div>
    <div><label>Number of Subjects:</label><span>{{ '{:,}'.format(header.subjects) }}</span></div>
    <div><label>Number of Transcripts:</label><span>{{ '{:,}'.format(header.transcripts) }}</span></div>
    <div><label>Transcripts per Subject:</label><span>{{ '{:.2f}'.format(header.ratio) }}</span></div>
    <div><label>Transcriber Count:</label><span>{{ '{:,}'.format(transcriber_count) }}</span></div>
  </header>

  <section id="users">
    <h2>Transcriber Summary</h2>
    <button title="Expand or collapse the top transcribers table"></button>
    <div class="users-container">
      <table>
        <thead>
          <tr>
            <th class="left">Transcriber</th>
            <th class="right">Count</th>
          </tr>
        </thead>
        <tbody>
          {% for transcriber in transcribers %}
          <tr>
            <td class="left">{{transcriber.name}}</td>
            <td class="right">{{ '{:,}'.format(transcriber.count) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="users-chart">
      <h2>Transcriptions per Transcriber</h2>
      <svg width="960" height="500"></svg>
    </div>

  </section>

  <section id="stats">
    <h2>Reconciliation Summary</h2>
    <table>
      <thead>
        <tr>
          <th colspan="2"></th>
          <th colspan="5">Reconciled</th>
          <th colspan="1"></th>
        </tr>
        <tr>
          <th class="left">Field</th>
          <th class="left">Type</th>
          <th class="right">Exact Matches</th>
          <th class="right">Fuzzy Matches</th>
          <th class="right">All Blank</th>
          <th class="right">One Transcript</th>
          <th class="right">Total</th>
          <th class="right">No Matches</th>
        </tr>
      </thead>
      <tbody>
        {% for row in reconciled %}
        <tr>
          <td class="left">{{row.name}}</td>
          <td class="left">{{row.col_type}}</td>
          <td class="right">{{ '{:,}'.format(row.num_exact_match) }}</td>
          <td class="right">{{ row.num_fuzzy_match }}</td>
          <td class="right">{{ '{:,}'.format(row.num_all_blank) }}</td>
          <td class="right">{{ '{:,}'.format(row.num_onesies) }}</td>
          <td class="right">{{ '{:,}'.format(row.num_reconciled) }}</td>
          <td class="right">{{ '{:,}'.format(row.num_no_match) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <section id="details">
    <h2>Reconciliation Detail</h2>
    <label>Filter Rows:</label>
    <select>
      <option value="__off__" selected="true">Show All</option>
      <option value="__all__">Show All Problems</option>
      {% for opt in options %}
        <option value="{{opt}}">Show Problems with: {{opt}}</option>
      {% endfor %}
    </select>
    <table>
      <thead>
        <tr class="closed">
          <th class="no-ul"><button title="Open or close all subjects"></button></th>
          {% for col in merged_cols[:-1] %}
            <th>{{col}}</th>
          {% endfor %}
      </tr>
      </thead>
      <tbody>
        {% for _, group in merged_df %}
          {% for row in group.itertuples() %}
            {% if row.row_type == row_types.explanations %}
              {% set explanations = row %}
              {% set row_problems = ','.join(problems[row.subject_id]) %}
            {% elif row.row_type == row_types.reconciled %}
              <tr class="closed" data-subject-id="{{row.subject_id}}"
                  data-row-type="{{row.row_type}}" data-problems="{{row_problems}}">
                <td><button title="Open or close this subject"></button></td>
                <td>{{row.subject_id}}</td>
                <td></td>
                {% for col in merged_cols[2:-1] %}
                  <td class="{{'problem' if problems[row.subject_id].get(col, None) else ''}}"
                      title="{{explanations[col]}}">
                    {{row[col]}}
                  </td>
                {% endfor %}
              </tr>
              <tr class="closed" data-subject-id="{{explanations.subject_id}}"
                  data-row-type="{{explanations.row_type}}" data-problems="{{row_problems}}">
                <td></td>
                <td></td>
                <td></td>
                {% for col in merged_cols[2:-1] %}
                  <td class="{{'filled' if explanations[col] else ''}}">{{explanations[col]}}</td>
                {% endfor %}
              </tr>
            {% elif row.row_type == row_types.unreconciled %}
              <tr class="closed" data-subject-id="{{row.subject_id}}"
                  data-row-type="{{row.row_type}}" data-problems="{{row_problems}}">
                <td></td>
                <td></td>
                <td>{{row.classification_id | int('')}}</td>
                {% for col in merged_cols[2:-1] %}
                  <td>{{row[col]}}</td>
                {% endfor %}
              </tr>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </section>

  <script>
  {% for line in d3 -%}
    {{line | safe }}
  {%- endfor %}
  </script>

<script>

const data = {{ transcribers | safe }};

const formatCount = d3.format(',.0f');

const svg = d3.select('#users-chart svg');

const pad = { top: 20, bottom: 100, left: 100, right: 100 };
const shiftLeftHi = 0;
const widthLo = 40;
const widthHi = +svg.attr('width') - pad.left - pad.right - widthLo;
const height = +svg.attr('height') - pad.top - pad.bottom;
const g = svg.append('g').attr('transform', 'translate(' + pad.left + ',' + pad.top + ')');

function value(d) {
  return d.count;
}

const xLo = d3.scaleLinear()
  .domain([1, 3])
  .rangeRound([0, widthLo]);

const xHi = d3.scaleLinear()
  .domain([3, d3.max(data, value) * 1.1])
  .rangeRound([3, widthHi]);

const binsLo = d3.histogram()
  .value(value)
  .domain(xLo.domain())
  .thresholds(xLo.ticks(2))
  (data);

const binsHi = d3.histogram()
  .value(value)
  .domain(xHi.domain())
  .thresholds(xHi.ticks(20))
  (data);

const y = d3.scaleLinear()
  .domain([0, d3.max(binsLo.concat(binsHi), function(d) { return d.length; })])
  .range([height, 0]);

const barLo = g.selectAll('.bar-lo')
  .data(binsLo)
  .enter()
    .append('g')
      .attr('class', 'bar bar-lo')
      .attr('transform', function(d) {
        return 'translate(' + xLo(d.x0) + ',' + y(d.length) + ')';
      });

const barHi = g.selectAll('.bar-hi')
  .data(binsHi)
  .enter()
    .append('g')
      .attr('class', 'bar bar-hi')
      .attr('transform', function(d) {
        return 'translate(' + (xHi(d.x0) + widthLo - shiftLeftHi) + ',' + y(d.length) + ')';
      });

function barHeight(d) {
  const h = height - y(d.length);
  d.height = h;
  return h;
}

barLo.append('rect')
  .attr('x', 1)
  .attr('width', function(d) { return xLo(d.x1) - xLo(d.x0) - 1; })
  .attr('height', barHeight);

barHi.append('rect')
 .attr('x', 1)
 .attr('width', function(d) { return xHi(d.x1) - xHi(d.x0) - 1; })
 .attr('height', barHeight);

function barText(d) {
  return d.height >= 15 ? formatCount(d.length) : '';
}

barLo.append('text')
  .attr('dy', '0.75em')
  .attr('y', 6)
  .attr('x', function(d) { return (xLo(d.x1) - xLo(d.x0)) / 2 })
  .attr('text-anchor', 'middle')
  .text(barText);

barHi.append('text')
  .attr('dy', '0.75em')
  .attr('y', 6)
  .attr('x', function(d) { return (xHi(d.x1) - xHi(d.x0)) / 2 })
  .attr('text-anchor', 'middle')
  .text(barText);

function plural(str, n) {
  str = formatCount(n) + ' ' + str;
  return n == 1 ? str : str + 's';
}

function titleText(d) {
  const span = d.x1 - d.x0 - 1;
  if (span) {
    return plural('transcriber', d.length) + ' completed between ' + d.x0 + ' and ' + (d.x0 + span) + ' transcriptions';
  } else {
    return plural('transcriber', d.length) + ' completed ' + plural('transcription', d.x0);
  }
}

barLo.append('svg:title')
  .text(titleText);

barHi.append('svg:title')
  .text(titleText);

const axisLo = d3.axisBottom()
  .scale(xLo)
  .ticks(2);

g.append('g')
  .attr('class', 'axis axis--x')
  .attr('transform', 'translate(0,' + height + ')')
  .call(axisLo);

g.append('g')
  .attr('class', 'axis axis--x')
  .attr('transform', 'translate(' + (widthLo - shiftLeftHi) + ',' + height + ')')
  .call(d3.axisBottom(xHi));

svg.append('text')
  .attr('text-anchor', 'middle')
  .attr('font-size', '1.25em')
  .attr('transform', 'translate(' + (pad.left * 0.75) + ',' + ((height + pad.top + pad.bottom) / 2) + ')rotate(-90)')
  .text('Number of Transcribers');

svg.append('text')
  .attr('text-anchor', 'middle')
  .attr('font-size', '1.25em')
  .attr('transform', 'translate(' + ((widthHi + pad.left + pad.right) / 2) + ',' + (height + pad.top + (pad.bottom / 2)) + ')')
  .text('Number of Transcriptions');

</script>

<script>
const users = document.querySelector('#users button');
const tbody = document.querySelector('#details tbody');
const thead = document.querySelector('#details thead');
const filter = document.querySelector('#details select');
const detailRows = document.querySelectorAll('#details tbody tr');

function toggleUsers(event) {
  const div = document.querySelector('#users .users-container');
  div.classList.toggle('expanded');
  event.target.classList.toggle('expanded');
}

function toggleClosed(event) {
  if (! event.target.matches('button')) { return; }
  const tr = event.target.parentElement.parentElement;
  const subjectId = tr.dataset.subjectId;
  const selector = '#details tbody tr[data-subject-id="' + subjectId + '"]';
  const trs = document.querySelectorAll(selector);
  trs.forEach(function(r) { r.classList.toggle('closed'); });
}

function toggleAllClosed(event) {
  if (! event.target.matches('button')) { return; }
  const tr = event.target.parentElement.parentElement;
  const selector = '#details tbody tr';
  const trs = document.querySelectorAll(selector);
  tr.classList.toggle('closed');
  if (tr.classList.contains('closed')) {
    trs.forEach(function(r) { r.classList.add('closed'); });
  } else {
    trs.forEach(function(r) { r.classList.remove('closed'); });
  }
}

function filterChange() {
  const filterValue = this.value;
  if (filterValue == '__off__') {
    detailRows.forEach(function(row) { row.classList.remove('hide'); });
  } else if (filterValue == '__all__') {
    detailRows.forEach(function(row) {
      if (row.dataset.problems) {
        row.classList.remove('hide');
      } else {
        row.classList.add('hide');
      }
    });
  } else {
    detailRows.forEach(function(row) {
      if (row.dataset.problems.indexOf(filterValue) > -1) {
        row.classList.remove('hide');
      } else {
        row.classList.add('hide');
      }
    });
  }
}

users.addEventListener('click', toggleUsers);
tbody.addEventListener('click', toggleClosed);
thead.addEventListener('click', toggleAllClosed);
filter.addEventListener('change', filterChange);
</script>

</body>
</html>
